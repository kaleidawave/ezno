name: Update LOC metrics (lines of code)

on:
  push:
    branches: ["main"]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: kaleidawave/release-downloader@improvements
        with:
          # TODO benchmark tool
          items: kaleidawave/experiments@assets[lines-of-code]
          
      - name: Run update script
        run: |
          function record {
            name=$1
            lines_of_code=$(lines-of-code $2)
        
            echo "\`$name\`: $lines_of_code" >> $GITHUB_STEP_SUMMARY

            curl \
              --header "Content-Type: application/json" \
              --header "X-POST-ACCESS-KEY: ${{ secrets.PROJECTS_POST_ACCESS_KEY }}" \
              --data "{\"project\":\"$name\",\"language\":\"rust\",\"loc\":$lines_of_code}" \
              https://project-information-kaleidawave.val.run/update-project
          }
          
          record "ezno-parser" "checker/**/*.rs"
          record "ezno-checker" "checker/**/*.rs"
          record "ezno" "src/**/*.rs"
